---
- name: Create folder for stemcell builder
  file: "dest={{stemcell_builder_path}} state=directory"

- name: Create bin folder for stemcell builder
  file: "dest={{stemcell_builder_path}}/bin state=directory"

- name: Put script file to the directory
  copy: "src=build-stemcell dest={{stemcell_builder_path}}/bin/build-stemcell mode=a+x"

- name: Put Gemfile to the directory
  copy: "src=Gemfile dest={{stemcell_builder_path}}/Gemfile"


- name: Clone BOSH repo from Altoros github for stemcell builder
  git: "repo=https://github.com/Altoros/bosh.git"
  sudo: no
  args:
    dest: "{{stemcell_builder_path}}/bosh"
    version: stemcell-builder-without-microbosh
    accept_hostkey: yes
  register: result
  until: not result|failed
  retries: 5

- name: Install BOSH gems
  shell: "bundle install"
  args:
    chdir: "{{stemcell_builder_path}}/bosh"
  sudo: no
  environment: ruby_environment

# - name: Download base os image for stemcell builder
#   get_url: "url=https://cloud-images.ubuntu.com/trusty/current/trusty-server-cloudimg-ppc64el.tar.gz"
#   args: 
#     dest: "{{stemcell_builder_path}}/base-os-image-trusty-ppc64el.tar.gz"
